package org.podval.docbook.gradle

import org.gradle.api.Project
import org.gradle.api.file.CopySpec
import java.io.File
import javax.xml.transform.stream.{StreamResult, StreamSource}
import org.apache.tools.ant.filters.ReplaceTokens
import org.xml.sax.InputSource
import scala.collection.JavaConverters._
import Util.writeInto

abstract class DocBook2 {

  def name: String

  def usesDocBookXslt2: Boolean

  def usesHtml: Boolean

  def usesCss: Boolean

  def embedsFonts: Boolean

  def usesIntermediate: Boolean

  def stylesheetName: String

  def stylesheetUriName: String

  def outputDirectoryName: String
  def outputFileExtension: String

  def intermediateDirectoryName: String = outputDirectoryName
  def intermediateFileExtension: String = outputFileExtension

  def parameterSections: Set[String] =
    Set(name, stylesheetName) ++
      (if (usesDocBookXslt2) Set.empty else  Set("common") ++ (if (!usesHtml) Set.empty else Set("common-html")))

  protected final def getSaxonOutputDirectory(layout: Layout): File = new File(
    if (usesIntermediate) layout.saxonOutputDirectoryRoot else layout.outputDirectoryRoot,
    if (usesIntermediate) intermediateDirectoryName else outputDirectoryName
  )

  protected final def getSaxonOutputFile(layout: Layout, inputFileName: String): File = getOutputFile(
    getSaxonOutputDirectory(layout),
    inputFileName,
    if (usesIntermediate) intermediateFileExtension else outputFileExtension
  )

  private def getOutputFile(directory: File, inputFileName: String, extension: String): File =
    new File(directory, outputFileNameOverride.getOrElse(inputFileName) + "." + extension)

  final def writeStylesheetFiles(
    layout: Layout,
    inputFileName: String,
    parameters: Map[String, String],
    cssFileName: String,
    epubEmbeddedFonts: String,
    logger: Logger
  ): Unit = {
    val customStylesheetName: String = layout.customStylesheet(stylesheetName)
    val paramsStylesheetName: String = layout.paramsStylesheet(stylesheetName)
    val stylesheetUri: String = s"${Stylesheets(usesDocBookXslt2).uri}/$stylesheetUriName.xsl"

    // xsl:param has the last value assigned to it, so customization must come last;
    // since it is imported (so as not to be overwritten), and import elements must come first,
    // a separate "-param" file is written with the "default" values for the parameters :)

    writeInto(layout.stylesheetFile(layout.mainStylesheet(stylesheetName)), logger, replace = true) {
      s"""<?xml version="1.0" encoding="UTF-8"?>
         |<!-- DO NOT EDIT! Generated by the DocBook plugin.
         |     Customizations go into $customStylesheetName. -->
         |<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform" version="1.0">
         |  <xsl:import href="$stylesheetUri"/>
         |  <xsl:import href="$paramsStylesheetName"/>
         |  <xsl:import href="$customStylesheetName"/>
         |</xsl:stylesheet>
         |"""
    }

    val allParameters: Map[String, String] =
      Map("img.src.path" -> (layout.imagesDirectoryName + "/")) ++
      (if (!usesHtml) Map.empty else Map(
        "base.dir" -> (getSaxonOutputDirectory(layout).getAbsolutePath + "/"),
        "root.filename" -> Util.fileNameWithoutExtension(getSaxonOutputFile(layout, inputFileName))
      )) ++
      (if (!embedsFonts) Map.empty else Map(
        "epub.embedded.fonts" -> epubEmbeddedFonts
      )) ++
      (if (!usesCss) Map.empty else Map(
        (if (usesDocBookXslt2) "html.stylesheets" else "html.stylesheet") -> layout.cssFileRelative(cssFileName)
      )) ++
      parameters

    writeInto(layout.stylesheetFile(paramsStylesheetName), logger, replace = true) {
      val parametersStr: String = allParameters.map { case (name: String, value: String) =>
        s"""  <xsl:param name="$name">$value</xsl:param>"""
      }.mkString("\n")

      s"""<?xml version="1.0" encoding="UTF-8"?>
         |<!-- DO NOT EDIT! Generated by the DocBook plugin.
         |     Customizations go into $customStylesheetName. -->
         |<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform" version="1.0">
         |$parametersStr
         |</xsl:stylesheet>
         |"""
    }

    writeInto(layout.stylesheetFile(customStylesheetName), logger, replace = false) {
      s"""<?xml version="1.0" encoding="UTF-8"?>
         |<!-- Customizations go here. -->
         |<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform" version="1.0">
         |</xsl:stylesheet>
         |"""
    }
  }

  final def run(
    layout: Layout,
    isJEuclidEnabled: Boolean,
    inputFileName: String,
    substitutions: Map[String, String],
    resolver: Resolver,
    project: Project,
    logger: Logger
  ): Unit = {
    logger.info(s"\nProcessing DocBook to $name")

    // Saxon output directory and file.
    val saxonOutputDirectory: File = getSaxonOutputDirectory(layout)
    val saxonOutputFile: File = getSaxonOutputFile(layout, inputFileName)
    saxonOutputDirectory.mkdirs

    // Saxon
    Saxon.run(
      inputSource = new InputSource(layout.inputFile(inputFileName).toURI.toASCIIString),
      stylesheetSource = new StreamSource(layout.stylesheetFile(layout.mainStylesheet(stylesheetName))),
      outputTarget = new StreamResult(saxonOutputFile),
      resolver = resolver,
      processingInstructionsSubstitutions = substitutions,
      useXslt2 = usesDocBookXslt2,
      logger = logger
    )

    val copyDestinationDirectory: File = Util.subdirectory(saxonOutputDirectory, copyDestinationDirectoryName)

    // Images.
    logger.info(s"Copying images")
    project.copy((copySpec: CopySpec) => copySpec
      .into(copyDestinationDirectory)
      .from(layout.imagesDirectory.getParentFile)
      .include(layout.imagesDirectoryName + "/**")
    )

    // CSS.
    if (usesCss) {
      logger.info(s"Copying CSS")
      project.copy((copySpec: CopySpec) => copySpec
        .into(copyDestinationDirectory)
        .from(layout.cssDirectory.getParentFile)
        .include(layout.cssDirectoryName + "/**")
        .filter(Map("tokens" -> substitutions.asJava).asJava, classOf[ReplaceTokens])
      )
    }

    // Post-processing.
    if (usesIntermediate) {
      logger.info(s"Post-processing $name")
      val outputDirectory: File = new File(layout.outputDirectoryRoot, outputDirectoryName)
      outputDirectory.mkdirs

      postProcess(
        layout = layout,
        useDocBookXslt2 = usesDocBookXslt2,
        isJEuclidEnabled = isJEuclidEnabled,
        inputDirectory = saxonOutputDirectory,
        inputFile = saxonOutputFile,
        outputFile = getOutputFile(outputDirectory, inputFileName, outputFileExtension),
        logger = logger
      )
    }
  }

  def outputFileNameOverride: Option[String] = None

  def copyDestinationDirectoryName: Option[String] = None

  protected def postProcess(
    layout: Layout,
    useDocBookXslt2: Boolean,
    isJEuclidEnabled: Boolean,
    inputDirectory: File,
    inputFile: File,
    outputFile: File,
    logger: Logger
  ): Unit = {
  }
}

object DocBook2 {

  object Html extends DocBook2 {
    override def usesDocBookXslt2: Boolean = false
    override def usesHtml: Boolean = true
    override def usesCss: Boolean = true
    override def embedsFonts: Boolean = false
    override def usesIntermediate: Boolean = false

    override def name: String = "html"
    override def stylesheetName: String = "html"
    override def stylesheetUriName: String = "html/chunk"

    override def outputDirectoryName: String = "html"
    override def outputFileExtension: String = "html"
    override def outputFileNameOverride: Option[String] = Some("index")
  }

  object Pdf extends DocBook2 {
    override def usesDocBookXslt2: Boolean = false
    override def usesHtml: Boolean = false
    override def usesCss: Boolean = false
    override def embedsFonts: Boolean = false
    override def usesIntermediate: Boolean = true

    override def name: String = "pdf"
    override def stylesheetName: String = "fo"
    override def stylesheetUriName: String = "fo/docbook"
    override def intermediateDirectoryName: String = "fo"
    override def intermediateFileExtension: String = "fo"
    override def outputDirectoryName: String = "pdf"
    override def outputFileExtension: String = "pdf"

    override protected def postProcess(
      layout: Layout,
      useDocBookXslt2: Boolean,
      isJEuclidEnabled: Boolean,
      inputDirectory: File,
      inputFile: File,
      outputFile: File,
      logger: Logger
    ): Unit = Fop.run(
      configurationFile = layout.fopConfigurationFile,
      isJEuclidEnabled = isJEuclidEnabled,
      inputFile = inputFile,
      baseDirectory = inputDirectory,
      outputFile = outputFile,
      logger = logger
    )
  }

  trait Epub extends DocBook2 {
    final override def usesHtml: Boolean = true
    final override def usesCss: Boolean = false
    final override def embedsFonts: Boolean = true
    final override def usesIntermediate: Boolean = true
    final override def outputFileExtension: String = "epub"
    final override def copyDestinationDirectoryName: Option[String] = Some("OEBPS")

    final override protected def postProcess(
      layout: Layout,
      useDocBookXslt2: Boolean,
      isJEuclidEnabled: Boolean,
      inputDirectory: File,
      inputFile: File,
      outputFile: File,
      logger: Logger
    ): Unit = {
      val zip = new org.apache.tools.ant.taskdefs.Zip
      zip.setProject(new org.apache.tools.ant.Project)
      zip.setPreserve0Permissions(true)
      zip.setCompress(false)
      zip.setDestFile(outputFile)
      val fileSet = new org.apache.tools.ant.types.FileSet()
      fileSet.setDir(inputDirectory)
      fileSet.appendIncludes(Array("mimetype", "META-INF/**", "OEBPS/**"))
      zip.addFileset(fileSet)
      zip.execute()
    }
  }

  object Epub2 extends Epub {
    override def name: String = "epub2"
    override def usesDocBookXslt2: Boolean = false
    override def outputDirectoryName: String = "epub"
    override def stylesheetName: String = "epub"
    override def stylesheetUriName: String = "epub/docbook"
  }

  object Epub3 extends Epub {
    override def name: String = "epub3"
    override def usesDocBookXslt2: Boolean = false
    override def outputDirectoryName: String = "epub3"
    override def stylesheetName: String = "epub3"
    override def stylesheetUriName: String = "epub3/chunk"
  }

  object Html2 extends DocBook2 {
    override def usesDocBookXslt2: Boolean = true
    override def usesHtml: Boolean = true
    override def usesCss: Boolean = true
    override def embedsFonts: Boolean = false
    override def usesIntermediate: Boolean = false

    override def name: String = "html2"
    override def stylesheetName: String = "html2"
    override def stylesheetUriName: String = "html/chunk" // TODO "html/html"?

    override def outputDirectoryName: String = "html2"
    override def outputFileExtension: String = "html"
    override def outputFileNameOverride: Option[String] = Some("index")
  }

  val processors: List[DocBook2] = List(Html, Epub2, Epub3, Pdf, Html2)
}
