## Static / Dynamic ##

This code pre-generates the static www.alter-rebbe.org site,
which is then further generated by Jekyll and published on GitHub Pages.

We are moving towards making the site dynamic, so that we can add:  
- search functionality;
- ability to modify the site.

To support self-contained dynamic site we need to replicate some of the Jekyll's functionality:
- compile SCSS into CSS: compass/jsass?;
- convert Markdown to HTML (blog, notes): flexmark-java or Laika (planet42.github.io/Laika).

## Facsimiles ##

Facsimiles displayed on the site are in the Google Storage bucket `facsimiles.alter-rebbe.org`,
where member "allUsers" has the role "Storag Object Viewer".
DNS has CNAME record for it that points to `c.storage.googleapis.com`,
so the files can be retrieved by anyone who has the correct URL.

To validate that facsimiles referenced from the site are in one-to-one correspondence with
the files in the bucket, we probably need to use Google Cloud Storage client to retrieve
(and cache) the list of them.
We also might want to use Google's CDN for them (Firebase Hosting?).

(I used BFG Repocleaner to remove facsimiles and their Git history from this repository
once they moved out.)
   
### Image Processing Commands ###

To extract images from PDF files:
```
  $ ls -1 *.pdf | xargs -I {} pdfimages -j {} {}
  $ rename '.pdf-000' '' *
```

To cut facsimiles:
```
  $ convert xxx.tif -crop 2x1+120@ x-%d.tif
```

To compress facsimiles:
```
  $ mogrify -path out -quality 80% -format jpg *.tif
```

To sync with the bucket:
```
  $ gsutil -m rsync -r -c -d <path-to-local-copy-of-the-bucket> gs://facsimiles.alter-rebbe.org
```

## Running on GCP ##

I am using [Cloud Run](https://cloud.google.com/run#key-features).

Service `collector` (`940416907592-compute@developer.gserviceaccount.com`;
URL `https://collector-qfkasghxtq-uk.a.run.app`) runs in us-eat4 and allows
unauthenticated requests.
DNS has CNAME record for `app.alter-rebbe.org` that points to `ghs.googlehosted.com.`

Memorystore/Redis turned out to be too expensive
(Google charges for *provisioned* capacity),
so the fact that Cloud Run probably can't talk to it even now (4/2020) isn't important :(
I may end up using [Cloud Firestore](https://firebase.google.com/docs/firestore)
for caching generated (and maybe even source) files.

### Docker ###

I am using [jib](https://github.com/GoogleContainerTools/jib) Gradle Plugin to
build and deploy my Docker image (`gcr.io/alter-rebbe/collector`).

To run the container locally:
```
  $ ./gradlew jibDockerBuild`
```

To push to Cloud Run via Container Registry:
```
  $ ./gradlew jib
```

(I do not see the need to set up [Cloud Build](https://cloud.google.com/cloud-build),
but if I do - it runs locally too!)

To make docker work locally, [I had to](https://linuxconfig.org/how-to-install-docker-on-fedora-31)
revert back to cgroup v1:
```
  $ sudo dnf install -y grubby
  $ sudo grubby --update-kernel=ALL --args="systemd.unified_cgroup_hierarchy=0"
  $ sudo reboot
```

## Monitoring ##

Stackdriver: Logging, Monitoring, Error reporting.

Cloud Debugger and Cloud Profiler.

### Logging ###

GCP supports Logback and java.util.logging; I use slf4j (with slf4j-jdk14.jar?).
How do I configure it to work with Cloud Logging? Just by adding
`'com.google.cloud:google-cloud-logging:1.101.1'` as a dependency?

Should I maybe switch to Typelevel's Scala Logging or `log4s` ?
How does ZIO handle logging?

I need to take care of the `http4s` access log.
